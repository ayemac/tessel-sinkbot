function e(e,t){var i,a;this.attiny=new n(e),this.connected=!1,this.lightTriggerLevel=null,this.soundTriggerLevel=null,this.pollingFrequency=500,this.lightPolling=!1,this.soundPolling=!1,this.pollInterval=void 0,a={firmwareFile:l,firmwareVersion:u,moduleID:r,signature:o,crc:s},(i=this).attiny.initialize(g,a,function(e){e?t?t(e):i.emit("error",e):(i.connected=!0,i.on("newListener",function(e){i.listeners(e).length||i._setListening(!0,e)}),i.on("removeListener",function(e){i.listeners(e).length||i._setListening(!1,e)}),setImmediate(function(){i.emit("ready"),i.irqwatcher=i._fetchTriggerValues.bind(i),i.attiny.setIRQCallback(i.irqwatcher)}),t&&t(null,i))})}var t=require("util"),i=require("events").EventEmitter,n=global.IS_TEST_ENV?require("./test/common/attiny-common-mock"):require("attiny-common"),r=8,o=37383,l=__dirname+"/firmware/src/ambient-attx4.hex",u=3,s=7861,g=100;t.inherits(e,i),e.prototype._fetchTriggerValues=function(){var e=this,t=new Buffer([6,0,0,0,0,0]);e.attiny.transceive(t,function(t,i){var n,r,o;e.attiny._validateResponse(i,[85,6])?(n=new Buffer(i.slice(2,i.length)),r=e._normalizeValue(n.readUInt16BE(0)),o=e._normalizeValue(n.readUInt16BE(2)),r&&e.lightTriggerLevel&&e.emit("light-trigger",r),o&&e.soundTriggerLevel&&e.emit("sound-trigger",o),setImmediate(function(){e.irqwatcher=e._fetchTriggerValues.bind(e),e.attiny.setIRQCallback(e.irqwatcher)})):console.warn("Warning... Invalid trigger values fetched...")})},e.prototype._getSingleDatum=function(e,t){this._readBuffer(e,2,t)},e.prototype._normalizeBuffer=function(e){var t,i=e.length/2,n=Array(i);for(t=0;t<i;t++)n[t]=this._normalizeValue(e.readUInt16BE(2*t));return n},e.prototype._normalizeValue=function(e){return e/1024},e.prototype._pollBuffers=function(e){var t=this;t.connected||t._establishCommunication(5,function(e){e&&t.emit("error",Error("Can't communicate with Ambient module..."))}),t.lightPolling&&t.getLightBuffer(e),t.soundPolling&&t.getSoundBuffer(e)},e.prototype._readBuffer=function(e,t,i){var n,r,o=this,l=new Buffer([e,t/2,0]),u=new Buffer(t);u.fill(0),(n=new Buffer(1)).writeUInt8(22,0),r=Buffer.concat([l,u,n]),o.attiny.transceive(r,function(n,r){var u;if(o.attiny._validateResponse(r,[85,e,t/2])&&22===r[r.length-1])return 1===(r=o._normalizeBuffer(r.slice(l.length,r.length-1))).length&&(r=r[0]),u=2===e?"light":"sound",o.emit(u,r),i&&i(null,r),r;i&&i(Error("Invalid response from Ambient module"))})},e.prototype._setListening=function(e,t){var i,n=this;if("light"===t)this.lightPolling=e;else{if("sound"!==t)return;this.soundPolling=e}("light"===t&&!this.soundPolling||"sound"===t&&!this.lightPolling)&&(i=function(){n._pollBuffers(function(){n._pollTimeout=setTimeout(i,n.pollingFrequency)})},e&&!n._pollTimeout?i():!e&&n._pollTimeout&&(clearTimeout(n._pollTimeout),n._pollTimeout=null))},e.prototype.disable=function(){this._setListening(!1,"light"),this._setListening(!1,"sound")},e.prototype._setTrigger=function(e,t,i){var n,r,o=this;t=Math.ceil(1024*t),(n=new Buffer(2)).writeUInt16BE(t,0),r=new Buffer([e,n.readUInt8(0),n.readUInt8(1),0]),o.attiny.transceive(r,function(r,l){if(o.attiny._validateResponse(l,[85,e,n.readUInt8(0),n.readUInt8(1)])){var u=4===e?"light-trigger-set":"sound-trigger-set";return 4===e?o.lightTriggerLevel=t:o.soundTriggerLevel=t,o.emit(u,t/1024),i&&i(null,t/1024),t}i&&i(Error("Invalid response from Ambient module for trigger set."))})},e.prototype.clearLightTrigger=function(e){this.setLightTrigger(0,e)},e.prototype.clearSoundTrigger=function(e){this.setSoundTrigger(0,e)},e.prototype.getLightBuffer=function(e){this._readBuffer(2,20,e)},e.prototype.getLightLevel=function(e){this._getSingleDatum(2,e)},e.prototype.getSoundBuffer=function(e){this._readBuffer(3,20,e)},e.prototype.getSoundLevel=function(e){this._getSingleDatum(3,e)},e.prototype.setLightTrigger=function(e,t){this._setTrigger(4,e,t)},e.prototype.setSoundTrigger=function(e,t){this._setTrigger(5,e,t)},exports.Ambient=e,exports.use=function(t,i){return t||console.warn(Error("Improperly specified Tessel port.")),new e(t,i)};