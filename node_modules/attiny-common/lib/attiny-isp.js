function e(e,n){return!!e&&(n&&n(e),!0)}function n(e,n,i,u){e.readEEPROM(2,0,function(e,n){u&&(e?u(e):u(null,n[0],n[1]))})}require("tessel");var i=require("sync-queue"),u=require("avr-isp");module.exports.updateFirmware=function(o,r,t){var a=u.use(o,{pageSize:64,fileName:r.firmwareFile}),c=new i;c.place(function(){!function(e,n,i){e.readSignature(function(u,o){u?i&&i(u):n==o?e.eraseChip(function(){e.programFuses(function(e){e?console.log(e):i()})}):i&&i(Error("Invalid Module signature. Are you sure you plugged in the right module?"))})}(a,r.signature,function(e){e?t&&t(e):c.next()})}),c.place(function(){!function(e,n){e.readPagesFromHexFile(function(i,u){i?n&&n(i):(console.warn("Uploading new firmware..."),e.flashImage(u,function(){console.warn("Update finished!"),n()}))})}(a,function(e){e?t&&t(e):c.next()})}),c.place(function(){setTimeout(function(){!function(i,u,o,r){n(i,0,0,function(t,a,c){e(t,r)||(a!==u||c!==o?i.writeEEPROM([u,o],0,function(u){e(u,r)||n(i,0,0,function(){r&&r()})}):r&&r())})}(a,r.moduleID,r.firmwareVersion,function(){t&&t()})},1e3)})},module.exports.getSignature=function(e,n){u.use(e).readSignature(n)};