function e(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-65+10:void 0}var t=require("tessel"),n=require("sync-queue"),r=require("fs"),o={lock:255,low:226,high:223,ext:255},i={lock:255,low:255,high:255,ext:255};ISP=function(e,n){this.chipSelect=e.digital[0].output().high(),this.reset=e.digital[1].output().high(),this.spi=new e.SPI({clockSpeed:125e3,mode:0}),this.success=t.led[0],this.programming=t.led[1],n=n||{},this.pageSize=n.pageSize||64,this.fname=n.fileName||"./attx4.hex",this.clockSpeed=125e3,this.incorrect=0},ISP.prototype._clockChange=function(e){this.clockSpeed!=e&&(this.clockSpeed=e,this.spi.setClockSpeed(e))},ISP.prototype.readSignature=function(e){var t,n=this;n.startProgramming(function(r){r?e(r):n._transfer([48,0,0,0],function(){n._transfer([48,0,1,0],function(r,o){t=o[3]<<8,n._transfer([48,0,2,0],function(n,r){return 0==(t|=r[3])||65535==t?e("Could not find a signature",t):e(null,t)})})})})},ISP.prototype.verifyFuses=function(e,t,r){var o=this;(new n).place(function(){o._transfer([80,0,0,0],function(e,n){return n[3]&t.low?r():r(Error("Could not verify low fuse"))})})},ISP.prototype.programFuses=function(e){var t=this;(new n).place(function(){t._transfer([172,160,0,o.low],function(){t.verifyFuses(o,i,function(n){t.endProgramming(function(){n?e(n):e()})})})})},ISP.prototype.readPagesFromHexFile=function(e){var t=this;r.readFile(t.fname,function(n,r){var o,i,s;n?e(n):(i=0,s=[],function n(a){a.position<r.length?(o=t._readImagePage(o.position,r,i),s.push({pageBuffer:o.page,address:i}),i+=t.pageSize,setImmediate(function(){n(o)})):e(null,s)}(o={position:-1}))})},ISP.prototype._readImagePage=function(t,n,r){function o(){s=((s=e(n[++t]))<<4)+e(n[++t]),a+=s}var i,s,a,f,u,c=this,p=0,l=n,g=[];for(f=0;f<c.pageSize;f++)g[f]=255;for(;;){if(58!=n[++t])return;if(i=e(n[++t]),i=(i<<4)+e(n[++t]),a=i,o(),u=s,o(),(u=(u<<8)+s)>=r+c.pageSize)return console.log("Error: line address bigger than pages",u),l;if(o(),1==s){t=n.length;break}for(f=0;f<i;f++)if(o(),g[p]=s,++p>c.pageSize){console.log("Error: too much code");break}if(o(),a%256!=0&&console.log("Error: bad checksum. Got",a),t++,13!=n[t]){if(10!=n[t]){console.log("Error: no end of line");break}}else if(10!=n[++t]){console.log("Error: no end of line");break}if(p==c.pageSize)break}return{position:t,page:new Buffer(g)}},ISP.prototype.flashImage=function(e,t){var r,o=this,i=new n,s=[];for(r=0;r<e.length;r++)i.place(function(n){s.push(o._queuePage(e[n].pageBuffer,e[n].address)),n+1<e.length?i.next():o.startProgramming(function(){o._flashAll(s,t)})}.bind(this,r))},ISP.prototype._flashAll=function(e,t){var n=this;e.length?this.spi.send(new Buffer(e[0]),function(){e.shift(),n._flashAll(e,t)}):n.endProgramming(function(){t()})},ISP.prototype._queuePage=function(e,t){var r,o,i=this,s=(new n,[]);for(r=0;r<i.pageSize/2;r++)if(o=r+t/2,s.push(64,o>>8&255,255&o,e[2*r]),s.push(72,o>>8&255,255&o,e[2*r+1]),r+1==i.pageSize/2)return t=t/2&65535,s.push(76,t>>8&255,255&t,0),s},ISP.prototype.verifyImage=function(e,t){var r,o=this,i=new n;for(o.incorrect=0,r=0;r<e.length;r++)i.place(function(n){o._readPage(e[n].pageBuffer,e[n].address,function(){n+1<e.length?i.next():t(null,o.incorrect)})}.bind(this,r))},ISP.prototype._readPage=function(e,t,r){var o,i=this,s=new n;for(o=0;o<i.pageSize/2;o++)s.place(function(n){i._readWord(0,n+t/2,e[2*n],function(){i._readWord(1,n+t/2,e[2*n+1],function(){n+1<i.pageSize/2?s.next():r()})})}.bind(this,o))},ISP.prototype._readWord=function(e,t,n,r){var o=this;this._transfer([32+8*e,t>>8&255,255&t,0],function(e,t){n!=t[3]?(o.incorrect++,r(e,t)):r(e,t)})},ISP.prototype.startProgramming=function(e){var t=this;t.reset.write(1),setTimeout(function(){t.reset.write(0),t.programming.write(1),t.spi.transfer(new Buffer([172,83,0,0]),function(t,n){n&&83==n[2]?e():e(Error("Programming confirmation not received."))})},50)},ISP.prototype.endProgramming=function(e){this.reset.write(1),this.programming.write(0),e()},ISP.prototype.eraseChip=function(e){var t=this;t._transfer([172,128,0,0],function(){t._busyWait(function(){e()})})},ISP.prototype.readEEPROM=function(e,t,r){var o,i=new Buffer(e),s=new n;for(o=0;o<e;o++)s.place(function(n){this.readEEPROMByte(t+n,function(t,o){if(t){if(r)return void r(t)}else i[n]=o,n==e-1?r&&r(null,i):s.next()})}.bind(this,o))},ISP.prototype.writeEEPROM=function(e,t,r){var o,i=new n;for(o=0;o<e.length;o++)i.place(function(n){this.writeEEPROMByte(e[n],t+n,function(t){t?r&&r(t):n==e.length-1?r&&r(null):i.next()})}.bind(this,o))},ISP.prototype.readEEPROMByte=function(e,t){this.accessEEPROMByte(160,e,0,t)},ISP.prototype.writeEEPROMByte=function(e,t,n){this.accessEEPROMByte(192,t,e,n)},ISP.prototype.accessEEPROMByte=function(e,t,n,r){var o=this;o.startProgramming(function(i){i?r&&r(i):o._transfer([e,0,t,n],function(e,t){e?r&&r(e):o.endProgramming(function(e){r&&r(e,t&&t[3])})})})},ISP.prototype._transfer=function(e,t){if(e.length%4!=0){var n="isp transfer called with wrong size. needs to be 4 bytes, got "+e;return console.log(n),t(n)}this.spi.transfer(new Buffer(e),function(e,n){t(null,n)})},ISP.prototype._busyWait=function(e){var t=this;this.spi.transfer(new Buffer([240,0,0,0]),function(n,r){return 1&r[3]?t._busyWait(e):e()})},module.exports.ISP=ISP,module.exports.FUSES=o,module.exports.MASK=i,module.exports.use=function(e,t){return new ISP(e,t)};